<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ball</title>
    <style>
        #id-canvas {
            border: 1px black solid;
        }
    </style>
    <script src='utils.js'></script>
    <script src='MoGame.js'></script>
    <script src='Block.js'></script>
    <script src='Ball.js'></script>
    <script src='Paddle.js'></script>
    <script src='level.js'></script>
</head>

<body>
    <canvas id='id-canvas' width="800" height="600"></canvas>
    <hr>
    <input id='id-input-speed' type="range" value="1">
</body>

<script>
    var loadLevel = function (n) {
        n = n - 1
        var level = levels[n]
        var blocks = []
        for (let i = 0; i < level.length; i++) {
            let p = level[i]
            let b = Block(p)
            blocks.push(b)
        }
        return blocks
    }
    var blocks = loadLevel(1)
    var paused = false
    var enableDebugMode = function (enable) {
        if (!enable) {
            return
        }
        window.addEventListener('keydown', function (event) {
            var k = event.key
            if (k == 'p') {
                paused = !paused
            } else if ('12345678'.includes(k)) {
                blocks = loadLevel(Number(k))
            }
        })
        document.querySelector('#id-input-speed').addEventListener('input', function (event) {
            var input = event.target
            window.fps = input.value + 1
            log(window.fps)
        })
    }

    var _main = function () {
        enableDebugMode(true)
        var game = MoGame(60)

        var paddle = Paddle()
        var ball = Ball()


        game.registerAction('a', function () {
            paddle.moveLeft()
        })
        game.registerAction('d', function () {
            paddle.moveRight()
        })
        game.registerAction('f', function () {
            ball.fire()
        })



        game.update = function () {
            if (paused) {
                return
            }
            ball.move()
            if (rectIntersects(ball, paddle) || rectIntersects(paddle, ball)) {
                ball.bounce()
            }
            // 判断 ball 和 block 相撞
            for (let i = 0; i < blocks.length; i++) {
                var block = blocks[i];
                if (block.collide(ball)) {
                    ball.bounce()
                    block.kill()
                }
            }
        }
        game.draw = function () {
            game.drawImage(paddle)
            game.drawImage(ball)
            for (let i = 0; i < blocks.length; i++) {
                var block = blocks[i];
                if (block.alive) {
                    game.drawImage(block)
                }
            }
        }
    }
    _main()
</script>

</html>